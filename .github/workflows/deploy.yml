name: Deploy via RSync

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy with RSync
      run: |
        rsync -avz -e "ssh -i ${{ secrets.SSH_KEY }}" \
          --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/var/www/html/Portfolio/

    - name: Verify deployment
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "‚úÖ RSync deployment completed!"
          echo "üìÇ Files in /var/www/html/Portfolio:"
          ls -la /var/www/html/Portfolio/
          echo "üåê Website status:"
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://lucaslugo.com